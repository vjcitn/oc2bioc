---
title: "Introduction to the oc2bioc package"
author:
- name: Vincent Carey
  affiliation: Channing Division of Network Medicine, Brigham and Women's Hospital
  email: stvjc@channing.harvard.edu
package: oc2bioc
output:
  BiocStyle::html_document
abstract: |
  This package defines simple interfaces between OpenCRAVAT and Bioconductor
vignette: |
  %\VignetteIndexEntry{Introduction to the oc2bioc package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: oc2bioc.bib
---

# Introduction

We propose a bidirectional interface between Bioconductor (@Huber2015) and OpenCRAVAT (@Pagel2020).

## Enumerating OpenCRAVAT "modules"

We aim for an interactively searchable table along the lines of

![filtered table of modules](filt.png)

We use the `open-cravat` python modules (installed with oc2bioc,
via the basilisk protocol) to obtain the listing of all modules.
This listing is managed in an S4 class instance:

```{r doo}
library(oc2bioc)
ms = populate_module_set()
ms
```

An as.data.frame method is available.
```{r lkh}
dim(as.data.frame(ms))
```

Use `DT::datatable` with the data.frame instance to obtain the
searchable table depicted above.

## Single-variant queries

The `queryOC` function authenticates to the OpenCRAVAT project's server
and uses the RESTful API to resolve queries.  If username and
password are not supplied, environment variables are queried
to obtain these.

Here's an illustration of how this works.  This chunk
will not run unless an OpenCRAVAT username and
password are supplied as the first two arguments.
```{r try1, eval=FALSE}
var_in_tx = queryOC([uname], [passwd], chr="chr7", pos="140753336", 
   ref="A", alt="T", 
   annotator=c("chasmplus_BRCA", "pubmed", "segway_breast"))
```
The response to this request (made on 6 Sept 2020 and saved) is:
```{r lkvar}
var_in_tx
names(httr::content(var_in_tx))
```
The content can be explored in a collapsible tree:
```{r dolistv}
listviewer::jsonedit(content(var_in_tx),height=200L)
```

Another illustration with a variant in a long non-coding RNA
(@Suvanto2020) is:
```{r dononc,eval=FALSE}
nonco_var = queryOC(chr="chr15", pos="50394581", ref="G", alt="C", 
   annotator=c("chasmplus_BRCA", "pubmed", "segway_breast", 
      "dbsnp", "ncrna", "gtex", "phdsnpg"))
```{r exam}
listviewer::jsonedit(content(nonco_var), height=300L)
```

# Working with a local deployment of OpenCRAVAT

## Using the REST API

When a local deployment is running, for example via `oc gui`,
`queryOC` can be used with appropriate settings of `baseURL`
to direct queries to locally installed annotators.

## Direct querying of annotator SQLite

Local deployments of OpenCRAVAT will have SQLite databases
corresponding to the installed annotators.  The `oc2bioc`
package includes utilities for identifying and
querying these.  

Here's an example.  Segway's lung data is actually all based on fetal lung tissue.
```
> list_local_annotators()
[1] "clinvar"       "genehancer"    "segway_lung"   "segway_muscle"
> lcon = connect_local_annotator("segway_lung")
> dbListTables(lcon)
 [1] "chr1"                    "chr10"                  
 [3] "chr11"                   "chr12"                  
 [5] "chr12_GL877875v1_alt"    "chr13"                  
...
> lcon %>% tbl("chr1") %>% glimpse()
Rows: ??
Columns: 5
Database: sqlite 3.30.1 [/home/stvjc/.local/lib/python3.8/site-packages/cravat/modules/annotators/segway_lung/data/segway_lung.sqlite]
$ bin    <int> 585, 585, 585, 585, 585, 585, 585, 585, 585, 585, 585, 585, 58…
$ start  <int> 11000, 13000, 13500, 14800, 15100, 54400, 54700, 55700, 79100,…
$ end    <int> 13000, 13500, 14800, 15100, 16100, 54700, 55700, 56000, 79300,…
$ tissue <chr> "FETAL_LUNG", "FETAL_LUNG", "FETAL_LUNG", "FETAL_LUNG", "FETAL…
$ state  <chr> "11_Quiescent", "9_Quiescent", "11_Quiescent", "9_Quiescent", …
```


# References
